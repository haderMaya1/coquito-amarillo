{% extends "base.html" %}

{% block title %}Gestión de Ventas{% endblock %}

{% block content %}
<div class="container">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-cart-check"></i> Gestión de Ventas</h2>
        <a href="{{ url_for('sales.create_sale') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nueva Venta
        </a>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="bi bi-funnel"></i> Filtros</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="fecha_inicio" class="form-label">Fecha Inicio</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-control"
                           value="{{ request.args.get('fecha_inicio', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="fecha_fin" class="form-label">Fecha Fin</label>
                    <input type="date" id="fecha_fin" name="fecha_fin" class="form-control"
                           value="{{ request.args.get('fecha_fin', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="cliente_id" class="form-label">Cliente</label>
                    <select id="cliente_id" name="cliente_id" class="form-select">
                        <option value="">Todos los clientes</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id_cliente }}"
                            {% if request.args.get('cliente_id') == cliente.id_cliente|string %}selected{% endif %}>
                            {{ cliente.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="vendedor_id" class="form-label">Vendedor</label>
                    <select id="vendedor_id" name="vendedor_id" class="form-select">
                        <option value="">Todos los vendedores</option>
                        {% for vendedor in vendedores %}
                        <option value="{{ vendedor.id_empleado }}"
                            {% if request.args.get('vendedor_id') == vendedor.id_empleado|string %}selected{% endif %}>
                            {{ vendedor.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 text-end mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-filter"></i> Filtrar
                    </button>
                    <a href="{{ url_for('sales.list_sales') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de ventas -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Ventas registradas</h5>
            <span class="badge bg-secondary">{{ ventas|length }} registros</span>
        </div>
        <div class="card-body p-0">
            {% if ventas %}
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Vendedor</th>
                            <th>Total</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for venta in ventas %}
                        <tr>
                            <td>{{ venta.id_venta }}</td>
                            <td>{{ venta.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>{{ venta.cliente.nombre if venta.cliente else 'N/A' }}</td>
                            <td>{{ venta.empleado.nombre if venta.empleado else 'N/A' }}</td>
                            <td>${{ "%.2f"|format(venta.total) }}</td>
                            <td class="text-end">
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('sales.view_sale', sale_id=venta.id_venta) }}"
                                       class="btn btn-info btn-sm" data-bs-toggle="tooltip" title="Ver detalles">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if venta.factura %}
                                    <a href="{{ url_for('sales.view_invoice', sale_id=venta.id_venta) }}"
                                       class="btn btn-warning btn-sm" data-bs-toggle="tooltip" title="Ver factura">
                                        <i class="bi bi-receipt"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-cart-x display-4 text-muted"></i>
                <p class="text-muted mt-2">No se encontraron ventas.</p>
                <a href="{{ url_for('sales.create_sale') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Registrar primera venta
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}